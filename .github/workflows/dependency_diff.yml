name: Dependency Diff

on:
  workflow_dispatch: {}
  pull_request: {}

jobs:
  diff-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Extract updated dependencies
        run: |
          echo "::notice ${pwd}"
          mkdir -p build/dependencies
          projects=$(./gradlew -q projects)
          echo "::notice $projects"
          for line in $(echo ${projects}); do
              if [[ $line =~ "':" ]]; then
                  project=${line:1:-1}
                  echo "::notice dumping $project dependencies"; 
                  ./gradlew $project:dependencies </dev/null > build/dependencies/$project.txt
                  echo "::notice $(cat build/dependencies/$project.txt)"
              fi
          done
          echo "::notice $(ls build/dependencies)"          
      - uses: actions/checkout@v3
        with:
          ref: other
          path: main
      - name: Extract main dependencies
        run: |
          cd main
          echo "::notice ${pwd}"
          mkdir -p build/dependencies
          projects=$(./gradlew -q projects)
          echo "::notice $projects"
          for line in $(echo ${projects}); do
              if [[ $line =~ "':" ]]; then
                  project=${line:1:-1}
                  echo "::notice dumping $project dependencies"; 
                  ./gradlew $project:dependencies </dev/null > build/dependencies/$project.txt
                  echo "::notice $(cat build/dependencies/$project.txt)"
              fi
          done  
          echo "::notice $(ls build/dependencies)"
      - name: Diff dependencies
        run: |
          echo "::notice ${pwd}"
          curl -L https://github.com/TWiStErRob/dependency-tree-diff/releases/download/1.3.0/dependency-tree-diff.jar > dependency-tree-diff.jar
          chmod +x dependency-tree-diff.jar
          mkdir -p build/dependencies-diff
          projects=$(./gradlew -q projects)

          echo 'DEPENDENCY_DIFF<<EOF' >> $GITHUB_ENV
          for line in $(echo ${projects}); do
              if [[ $line =~ "':" ]]; then
                  project=${line:1:-1}
                  echo "::notice diffing $project dependencies"; 
                  echo "### $project" >> $GITHUB_ENV
                  echo '```diff' >> $GITHUB_ENV
                  ./dependency-tree-diff.jar main/build/dependencies/$project.txt build/dependencies/$project.txt  >> $GITHUB_ENV
                  echo '```' >> $GITHUB_ENV
              fi
          done
          echo 'EOF' >> $GITHUB_ENV
      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ## Dependencies diff
            ${{ env.DEPENDENCY_DIFF }}
